{% extends "cash_flow/base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-warning text-white">
        <h2 class="mb-0">Редактирование записи</h2>
    </div>
    <div class="card-body">
        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            
            <!-- Дата -->
            <div class="mb-3">
                <label for="{{ form.date.id_for_label }}" class="form-label">
                    Дата операции <span class="text-danger">*</span>
                </label>
                {{ form.date }}
            </div>
            
            <!-- Статус -->
            <div class="mb-3">
                <label for="{{ form.status.id_for_label }}" class="form-label">
                    Статус <span class="text-danger">*</span>
                </label>
                {{ form.status }}
            </div>
            
            <!-- Тип операции -->
            <div class="mb-3">
                <label for="{{ form.type.id_for_label }}" class="form-label">
                    Тип операции <span class="text-danger">*</span>
                </label>
                {{ form.type }}
            </div>
            
            <!-- Категория -->
            <div class="mb-3">
                <label for="{{ form.category.id_for_label }}" class="form-label">
                    Категория <span class="text-danger">*</span>
                </label>
                {{ form.category }}
            </div>
            
            <!-- Подкатегория -->
            <div class="mb-3">
                <label for="{{ form.subcategory.id_for_label }}" class="form-label">
                    Подкатегория <span class="text-danger">*</span>
                </label>
                {{ form.subcategory }}
            </div>
            
            <!-- Сумма -->
            <div class="mb-3">
                <label for="{{ form.amount.id_for_label }}" class="form-label">
                    Сумма (руб.) <span class="text-danger">*</span>
                </label>
                {{ form.amount }}
            </div>
            
            <!-- Комментарий -->
            <div class="mb-3">
                <label for="{{ form.comment.id_for_label }}" class="form-label">
                    Комментарий
                </label>
                {{ form.comment }}
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <a href="{% url 'index' %}" class="btn btn-secondary me-md-2">
                    <i class="bi bi-x-circle"></i> Отмена
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Сохранить изменения
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Динамическая загрузка подкатегорий при изменении категории
document.getElementById('id_category').addEventListener('change', function() {
    const categoryId = this.value;
    const subcategorySelect = document.getElementById('id_subcategory');
    subcategorySelect.innerHTML = '<option value="">---------</option>';
    
    if (categoryId) {
        fetch(`/api/subcategories/?category_id=${categoryId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory.id;
                    option.textContent = subcategory.name;
                    subcategorySelect.appendChild(option);
                });
                
                // Устанавливаем текущее значение подкатегории после загрузки
                const currentSubcategoryId = "{{ form.instance.subcategory.id }}";
                if (currentSubcategoryId) {
                    subcategorySelect.value = currentSubcategoryId;
                }
            });
    }
});

// Инициализация подкатегорий при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    const categoryId = document.getElementById('id_category').value;
    if (categoryId) {
        const event = new Event('change');
        document.getElementById('id_category').dispatchEvent(event);
    }
});
</script>
{% endblock %}